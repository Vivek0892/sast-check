trigger:
- main

resources:
- repo: self

variables:
  imageName: 'nodejs-app:$(Build.BuildId)'

stages:
- stage: Build
  jobs:
  - job: BuildImage
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Docker@2
      inputs:
        command: 'build'
        dockerfile: '**/Dockerfile'
        tags: |
          $(imageName)

- stage: Push
  jobs:
  - job: PushImage
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Docker@2
      inputs:
        command: 'push'
        repository: 'myvueapp.azurecr.io/nodejs-app'
        tags: |
          $(imageName)
        containerRegistry: |
          $(dockerRegistryServiceConnection)

  - stage: ValidateKubernetesManifests
    jobs:
      - job: KubeScoreValidation
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          - script: |
              docker pull zegl/kube-score:latest
              docker run --rm -v $(System.DefaultWorkingDirectory)/deployment:/k8s zegl/kube-score score /deployment/*.yaml
            displayName: 'Run Kube-score'

- stage: Deploy
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployToAKS
    environment: 'MyAKSCluster'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo "Deploying to AKS"
